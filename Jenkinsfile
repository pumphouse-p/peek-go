pipeline {
  agent any

  tools {
    go "golang-1.16.14"
  }

  stages {
    stage('Build Go Binary') {
      steps {
        echo ''
        echo '================================================================================'
        echo '==                              START BUILD                                   =='
        echo '================================================================================'
        echo ''

        sh "go build -o ./cmd/peek-go ./cmd/peek-go/"

        echo ''
        echo '================================================================================'
        echo '==                               END BUILD                                    =='
        echo '================================================================================'
        echo ''
      }
    }
    stage('Test') {
      steps {
        echo ''
        echo '================================================================================'
        echo '==                               START TEST                                   =='
        echo '================================================================================'
        echo ''

        sh "go test ./..."

        echo ''
        echo '================================================================================'
        echo '==                                END TEST                                    =='
        echo '================================================================================'
        echo ''
      }
    }
    stage('Build Release Image') {
      steps {
        echo ''
        echo '================================================================================'
        echo '==                            START IMAGE BUILD                               =='
        echo '================================================================================'
        echo ''
        
        sh "buildah bud -t quay.io/deparris/peek-go:jenkins"

        echo ''
        echo '================================================================================'
        echo '==                            END IMAGE BUILD                                 =='
        echo '================================================================================'
        echo ''
      }
    }
    stage('Publish Release Image') {
      environment {
        IMAGE_REGISTRY = credentials("${params.IMAGE_REGISTRY_CREDENTIALS}")
      }

      steps {
        echo ''
        echo '================================================================================'
        echo '==                            START IMAGE PUSH                                =='
        echo '================================================================================'
        echo ''
        
        sh 'buildah push --creds "${IMAGE_REGISTRY_USR}":"${IMAGE_REGISTRY_PSW}" quay.io/deparris/peek-go:jenkins'

        echo ''
        echo '================================================================================'
        echo '==                            END IMAGE PUSH                                  =='
        echo '================================================================================'
        echo ''
      }
    }
  }
}
